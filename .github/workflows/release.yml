name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release
    runs-on: macos-latest
    
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show environment info
      run: |
        echo "## Build Environment" >> $GITHUB_STEP_SUMMARY
        xcodebuild -version >> $GITHUB_STEP_SUMMARY

    - name: Build PixelClock (Intel & Apple Silicon & Universal)
      run: |
        # 1. ç¼–è¯‘ Intel ç‰ˆæœ¬
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/x86_64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="x86_64" ONLY_ACTIVE_ARCH=NO
        
        # 2. ç¼–è¯‘ Apple Silicon ç‰ˆæœ¬
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/arm64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64" ONLY_ACTIVE_ARCH=NO

        # 3. ç¼–è¯‘ Universal ç‰ˆæœ¬ (é€šç”¨äºŒè¿›åˆ¶)
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath "$GITHUB_WORKSPACE/build/DerivedData" -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64 x86_64" ONLY_ACTIVE_ARCH=NO

    - name: Create Multiple ZIP archives
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          VERSION="manual-${GITHUB_RUN_NUMBER}"
        fi
        
        # æ‰“åŒ… Intel
        cd "$GITHUB_WORKSPACE/build/x86_64/Build/Products/Release"
        zip -r "$GITHUB_WORKSPACE/PixelClock-${VERSION}-macOS-Intel.zip" PixelClock.app
        
        # æ‰“åŒ… Apple Silicon
        cd "$GITHUB_WORKSPACE/build/arm64/Build/Products/Release"
        zip -r "$GITHUB_WORKSPACE/PixelClock-${VERSION}-macOS-AppleSilicon.zip" PixelClock.app
        
        # æ‰“åŒ… Universal
        cd "$GITHUB_WORKSPACE/build/DerivedData/Build/Products/Release"
        zip -r "$GITHUB_WORKSPACE/PixelClock-${VERSION}-macOS-Universal.zip" PixelClock.app

    - name: Release to GitHub
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        # è¿™é‡ŒæŒ‡å®šçš„æ–‡ä»¶ä¼šä½œä¸º 3 ä¸ªç‹¬ç«‹çš„é™„ä»¶å‡ºç°åœ¨ Release é¡µé¢
        files: |
          PixelClock-*-macOS-Intel.zip
          PixelClock-*-macOS-AppleSilicon.zip
          PixelClock-*-macOS-Universal.zip
        name: PixelClock ${{ github.ref_name }}
        body: |
          ## ğŸš€ PixelClock ${{ github.ref_name }}
          
          ### ğŸ“¦ èµ„äº§è¯´æ˜
          - **Universal**: é€šç”¨ç‰ˆæœ¬ï¼ˆæ¨èï¼‰ï¼ŒåŒæ—¶æ”¯æŒ Intel å’Œ Apple Siliconã€‚
          - **AppleSilicon**: ä»…é€‚ç”¨äº M1/M2/M3 èŠ¯ç‰‡ã€‚
          - **Intel**: ä»…é€‚ç”¨äº Intel èŠ¯ç‰‡çš„è€æ¬¾ Macã€‚
          
          ---
          *ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒã€‚*
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Archive artifacts for debugging
      uses: actions/upload-artifact@v4
      with:
        name: PixelClock-Build-Artifacts
        path: "*.zip"
        retention-days: 7
