name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release
    runs-on: macos-latest
    
    # 显式声明权限，解决之前遇到的 HTTP 403 问题
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show environment info
      run: |
        echo "## Build Environment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner OS**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
        xcodebuild -version >> $GITHUB_STEP_SUMMARY

    - name: Build PixelClock (Release)
      run: |
        # 使用标准构建指令，指定输出路径和 SDK
        xcodebuild -project PixelClock.xcodeproj \
          -scheme PixelClock \
          -configuration Release \
          -derivedDataPath build/DerivedData \
          -sdk macosx \
          -destination 'platform=macOS' \
          build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create ZIP archive
      run: |
        # 1. 定位到标准的 Release 输出目录
        RELEASE_DIR="build/DerivedData/Build/Products/Release"
        
        if [ ! -d "$RELEASE_DIR/PixelClock.app" ]; then
          echo "ERROR: PixelClock.app not found in $RELEASE_DIR"
          ls -R build/DerivedData/Build/Products/
          exit 1
        fi
        
        # 2. 进入目录并压缩
        cd "$RELEASE_DIR"
        
        # 打印包信息，方便在 Action 日志中确认架构
        echo "### Binary Info"
        file PixelClock.app/Contents/MacOS/PixelClock
        
        zip -r PixelClock-Release-macOS.zip PixelClock.app
        
        # 3. 设置绝对路径到环境变量
        FULL_PATH=$(realpath PixelClock-Release-macOS.zip)
        echo "ZIP_PATH=$FULL_PATH" >> $GITHUB_ENV
        echo "Created ZIP at: $FULL_PATH"

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        # 使用 GitHub 官方 CLI 工具创建 Release 并上传附件
        gh release create "$TAG" \
          --title "Release $TAG" \
          --notes "Automated release for $TAG" \
          "$ZIP_PATH"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ZIP_PATH: ${{ env.ZIP_PATH }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PixelClock-Release-macOS
        path: ${{ env.ZIP_PATH }}
        retention-days: 90
