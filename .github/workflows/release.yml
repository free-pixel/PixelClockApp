name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release
    runs-on: macos-latest
    
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show environment info
      run: |
        echo "## Build Environment" >> $GITHUB_STEP_SUMMARY
        xcodebuild -version >> $GITHUB_STEP_SUMMARY

    - name: Build PixelClock (Intel & Apple Silicon)
      run: |
        # --- 1. 编译 Intel 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/x86_64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="x86_64" ONLY_ACTIVE_ARCH=NO
        
        # --- 2. 编译 Apple Silicon 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/arm64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64" ONLY_ACTIVE_ARCH=NO

    - name: Create ZIP archives
      run: |
        VERSION="${GITHUB_REF#refs/tags/}"
        
        # 打包 Intel
        cd build/x86_64/Build/Products/Release
        zip -r "../../../../PixelClock-${VERSION}-Intel.zip" PixelClock.app
        cd -
        
        # 打包 Apple Silicon
        cd build/arm64/Build/Products/Release
        zip -r "../../../../PixelClock-${VERSION}-Apple-Silicon.zip" PixelClock.app
        cd -

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        # 使用 *.zip 自动上传目录下所有的压缩包
        gh release create "$TAG" \
          --title "Release $TAG" \
          --notes "Automated release for $TAG (Intel & Apple Silicon versions)" \
          *.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PixelClock-Release-macOS
        path: "*.zip"
        retention-days: 90
