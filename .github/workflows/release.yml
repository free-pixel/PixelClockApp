name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release
    runs-on: macos-latest
    
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show environment info
      run: |
        echo "## Build Environment" >> $GITHUB_STEP_SUMMARY
        xcodebuild -version >> $GITHUB_STEP_SUMMARY

    - name: Build PixelClock (Intel & Apple Silicon)
      run: |
        # --- 1. 编译 Intel 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/x86_64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="x86_64" ONLY_ACTIVE_ARCH=NO
        
        # --- 2. 编译 Apple Silicon 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/arm64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64" ONLY_ACTIVE_ARCH=NO

    - name: Build PixelClock (Release)
      run: |
        # 使用绝对路径确保万无一失
        xcodebuild -project PixelClock.xcodeproj \
          -scheme PixelClock \
          -configuration Release \
          -derivedDataPath "$GITHUB_WORKSPACE/build/DerivedData" \
          -sdk macosx \
          -destination 'platform=macOS' \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64 x86_64" \
          ONLY_ACTIVE_ARCH=NO

    - name: Create Multiple ZIP archives
      run: |
        VERSION="${GITHUB_REF#refs/tags/}"
        
        # 打包 Intel 版本 (来自第一步的 derivedDataPath)
        cd "$GITHUB_WORKSPACE/build/x86_64/Build/Products/Release"
        zip -r "$GITHUB_WORKSPACE/PixelClock-${VERSION}-macOS-Intel.zip" PixelClock.app
        
        # 打包 Apple Silicon 版本 (来自第二步的 derivedDataPath)
        cd "$GITHUB_WORKSPACE/build/arm64/Build/Products/Release"
        zip -r "$GITHUB_WORKSPACE/PixelClock-${VERSION}-macOS-AppleSilicon.zip" PixelClock.app
        
        # 打包 Universal 版本 (来自第三步的 derivedDataPath)
        cd "$GITHUB_WORKSPACE/build/DerivedData/Build/Products/Release"
        zip -r "$GITHUB_WORKSPACE/PixelClock-${VERSION}-macOS-Universal.zip" PixelClock.app

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PixelClock-Release-macOS
        path: "*.zip"
        retention-days: 90
