name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release
    runs-on: macos-latest
    
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show environment info
      run: |
        echo "## Build Environment" >> $GITHUB_STEP_SUMMARY
        xcodebuild -version >> $GITHUB_STEP_SUMMARY

    - name: Build PixelClock (Intel & Apple Silicon)
      run: |
        # --- 1. 编译 Intel 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/x86_64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="x86_64" ONLY_ACTIVE_ARCH=NO
        
        # --- 2. 编译 Apple Silicon 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/arm64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64" ONLY_ACTIVE_ARCH=NO

    - name: Create ZIP archive
      run: |
        # 1. 设置变量
        VERSION="${GITHUB_REF#refs/tags/}"
        ZIP_NAME="PixelClock-${VERSION}-macOS-Universal.zip"
        RELEASE_DIR="build/DerivedData/Build/Products/Release"
        
        # 2. 进入产物目录
        cd "$RELEASE_DIR"
        
        # 3. 压缩并将压缩包存放到项目根目录 (即 ../../../../../ )
        # 或者直接用绝对路径 $GITHUB_WORKSPACE
        zip -r "$GITHUB_WORKSPACE/$ZIP_NAME" PixelClock.app
        
        # 4. 回到根目录 (可选，为了清晰)
        cd "$GITHUB_WORKSPACE"
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        # 现在根目录下一定能找到这个 zip 了
        gh release create "$TAG" \
          --title "Release $TAG" \
          --notes "Automated release for $TAG (Intel & Apple Silicon versions)" \
          PixelClock-*-macOS-Universal.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PixelClock-Release-macOS
        path: "*.zip"
        retention-days: 90
