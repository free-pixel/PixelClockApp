name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release
    runs-on: macos-latest
    
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show environment info
      run: |
        echo "## Build Environment" >> $GITHUB_STEP_SUMMARY
        xcodebuild -version >> $GITHUB_STEP_SUMMARY

    - name: Build PixelClock (Intel & Apple Silicon)
      run: |
        # --- 1. 编译 Intel 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/x86_64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="x86_64" ONLY_ACTIVE_ARCH=NO
        
        # --- 2. 编译 Apple Silicon 版本 ---
        xcodebuild -project PixelClock.xcodeproj -scheme PixelClock -configuration Release \
          -derivedDataPath build/arm64 -sdk macosx -destination 'platform=macOS' \
          clean build CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64" ONLY_ACTIVE_ARCH=NO

    - name: Build PixelClock (Release)
      run: |
        # 使用绝对路径确保万无一失
        xcodebuild -project PixelClock.xcodeproj \
          -scheme PixelClock \
          -configuration Release \
          -derivedDataPath "$GITHUB_WORKSPACE/build/DerivedData" \
          -sdk macosx \
          -destination 'platform=macOS' \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MACOSX_DEPLOYMENT_TARGET=13.0 \
          ARCHS="arm64 x86_64" \
          ONLY_ACTIVE_ARCH=NO

    - name: Create ZIP archive
      run: |
        VERSION="${GITHUB_REF#refs/tags/}"
        ZIP_NAME="PixelClock-${VERSION}-macOS-Universal.zip"
        
        # 使用绝对路径定位到产物目录
        RELEASE_DIR="$GITHUB_WORKSPACE/build/DerivedData/Build/Products/Release"
        
        # 打印当前目录结构，如果报错，方便我们在日志里查路径
        echo "Searching for App in: $RELEASE_DIR"
        
        if [ ! -d "$RELEASE_DIR/PixelClock.app" ]; then
          echo "ERROR: PixelClock.app not found. Current directory structure:"
          ls -R "$GITHUB_WORKSPACE/build"
          exit 1
        fi
        
        # 直接在 Release 目录下压缩，并将输出存到根目录
        cd "$RELEASE_DIR"
        zip -r "$GITHUB_WORKSPACE/$ZIP_NAME" PixelClock.app
        
        # 回到根目录，确认为后续步骤准备好了
        cd "$GITHUB_WORKSPACE"
        echo "ZIP_PATH=$GITHUB_WORKSPACE/$ZIP_NAME" >> $GITHUB_ENV
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PixelClock-Release-macOS
        path: "*.zip"
        retention-days: 90
