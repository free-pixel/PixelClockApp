name: Build PixelClock

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build:
    name: Build PixelClock
    runs-on: macos-latest

    strategy:
      matrix:
        configuration: [Debug, Release]
        architecture: [universal, arm64]
        exclude:
          - configuration: Debug
            architecture: universal

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: |
        xcodebuild -version
        swift --version

    - name: Build PixelClock
      run: |
        if [ "${{ matrix.architecture }}" = "universal" ]; then
          xcodebuild -project PixelClock.xcodeproj \
            -target PixelClock \
            -configuration ${{ matrix.configuration }} \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        else
          xcodebuild -project PixelClock.xcodeproj \
            -target PixelClock \
            -configuration ${{ matrix.configuration }} \
            ARCHS=${{ matrix.architecture }} \
            ONLY_ACTIVE_ARCH=YES \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        fi

    - name: Package app
      if: matrix.architecture == 'universal'
      run: |
        APP_PATH="build/${{ matrix.configuration }}/PixelClock.app"
        ZIP_NAME="PixelClock-${{ matrix.configuration }}-macOS.zip"
        ditto -c -k --sequesterRsrc "$APP_PATH" "$ZIP_NAME"
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

    - name: Upload build artifact
      if: matrix.architecture == 'universal'
      uses: actions/upload-artifact@v4
      with:
        name: PixelClock-${{ matrix.configuration }}-macOS
        path: ${{ env.ZIP_NAME }}
        retention-days: 30

    - name: Build summary
      if: matrix.architecture == 'universal'
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**: ${{ matrix.configuration }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture**: ${{ matrix.architecture }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: macOS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "\`${{ env.ZIP_NAME }}\` uploaded as artifact" >> $GITHUB_STEP_SUMMARY

  build-arm64-only:
    name: Build Debug (ARM64)
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: |
        xcodebuild -version
        swift --version

    - name: Build PixelClock (ARM64 Debug)
      run: |
        xcodebuild -project PixelClock.xcodeproj \
          -target PixelClock \
          -configuration Debug \
          ARCHS=arm64 \
          ONLY_ACTIVE_ARCH=YES \
          clean build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Verify binary
      run: |
        file build/Debug/PixelClock.app/Contents/MacOS/PixelClock
        lipo -info build/Debug/PixelClock.app/Contents/MacOS/PixelClock
